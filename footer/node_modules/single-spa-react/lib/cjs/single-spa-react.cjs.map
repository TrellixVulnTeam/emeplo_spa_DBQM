{"version":3,"file":"single-spa-react.cjs","sources":["../../src/single-spa-react.js"],"sourcesContent":["/* We don't import parcel.component.js from this file intentionally. See comment\n * in that file for why\n */\n\n// React context that gives any react component the single-spa props\nexport let SingleSpaContext = null;\n\n// This try/catch exists mostly to prevent rollup from thinking that SingleSpaContext\n// is null and then doing optimizations in parcel.js that cause bugs.\n// See https://github.com/single-spa/single-spa-react/issues/105\n\ntry {\n  // single-spa-react is usable as a global script, as a systemjs module, and other\n  // situations where require() is unavailable. This is why we require the user to\n  // pass in opts.React and opts.ReactDOM - to avoid the mess of \"how do i properly load react\".\n  // However, in situations where require() is available, we can use it this way to create\n  // the react context. The try/catch defensiveness keeps single-spa-react working in\n  // as many situations as possible.\n  SingleSpaContext = require(\"react\").createContext();\n} catch {\n  // ignore\n}\n\nconst defaultOpts = {\n  // required opts\n  React: null,\n  ReactDOM: null,\n\n  // required - one or the other\n  rootComponent: null,\n  loadRootComponent: null,\n\n  // optional opts\n  renderType: null,\n  errorBoundary: null,\n  errorBoundaryClass: null,\n  domElementGetter: null,\n  parcelCanUpdate: true, // by default, allow parcels created with single-spa-react to be updated\n  suppressComponentDidCatchWarning: false,\n  domElements: {},\n  renderResults: {},\n};\n\nexport default function singleSpaReact(userOpts) {\n  if (typeof userOpts !== \"object\") {\n    throw new Error(`single-spa-react requires a configuration object`);\n  }\n\n  const opts = {\n    ...defaultOpts,\n    ...userOpts,\n  };\n\n  if (!opts.React) {\n    throw new Error(`single-spa-react must be passed opts.React`);\n  }\n\n  if (!opts.ReactDOM) {\n    throw new Error(`single-spa-react must be passed opts.ReactDOM`);\n  }\n\n  if (!opts.rootComponent && !opts.loadRootComponent) {\n    throw new Error(\n      `single-spa-react must be passed opts.rootComponent or opts.loadRootComponent`\n    );\n  }\n\n  if (opts.errorBoundary && typeof opts.errorBoundary !== \"function\") {\n    throw Error(\n      `The errorBoundary opt for single-spa-react must either be omitted or be a function that returns React elements`\n    );\n  }\n\n  if (!SingleSpaContext && opts.React.createContext) {\n    SingleSpaContext = opts.React.createContext();\n  }\n\n  const lifecycles = {\n    bootstrap: bootstrap.bind(null, opts),\n    mount: mount.bind(null, opts),\n    unmount: unmount.bind(null, opts),\n  };\n\n  if (opts.parcelCanUpdate) {\n    lifecycles.update = update.bind(null, opts);\n  }\n\n  return lifecycles;\n}\n\nfunction bootstrap(opts, props) {\n  if (opts.rootComponent) {\n    // This is a class or stateless function component\n    return Promise.resolve();\n  } else {\n    // They passed a promise that resolves with the react component. Wait for it to resolve before mounting\n    return opts.loadRootComponent(props).then((resolvedComponent) => {\n      opts.rootComponent = resolvedComponent;\n    });\n  }\n}\n\nfunction mount(opts, props) {\n  return new Promise((resolve, reject) => {\n    if (\n      !opts.suppressComponentDidCatchWarning &&\n      atLeastReact16(opts.React) &&\n      !opts.errorBoundary\n    ) {\n      if (!opts.rootComponent.prototype) {\n        console.warn(\n          `single-spa-react: ${\n            props.name || props.appName || props.childAppName\n          }'s rootComponent does not implement an error boundary.  If using a functional component, consider providing an opts.errorBoundary to singleSpaReact(opts).`\n        );\n      } else if (!opts.rootComponent.prototype.componentDidCatch) {\n        console.warn(\n          `single-spa-react: ${\n            props.name || props.appName || props.childAppName\n          }'s rootComponent should implement componentDidCatch to avoid accidentally unmounting the entire single-spa application.`\n        );\n      }\n    }\n\n    const domElementGetter = chooseDomElementGetter(opts, props);\n\n    if (typeof domElementGetter !== \"function\") {\n      throw new Error(\n        `single-spa-react: the domElementGetter for react application '${\n          props.appName || props.name\n        }' is not a function`\n      );\n    }\n\n    const whenMounted = function () {\n      resolve(this);\n    };\n\n    const elementToRender = getElementToRender(opts, props, whenMounted);\n    const domElement = getRootDomEl(domElementGetter, props);\n    const renderResult = reactDomRender({\n      elementToRender,\n      domElement,\n      opts,\n    });\n    opts.domElements[props.name] = domElement;\n    opts.renderResults[props.name] = renderResult;\n  });\n}\n\nfunction unmount(opts, props) {\n  return new Promise((resolve) => {\n    opts.unmountFinished = resolve;\n\n    const root = opts.renderResults[props.name];\n\n    if (root && root.unmount) {\n      // React >= 18\n      const unmountResult = root.unmount();\n    } else {\n      // React < 18\n      opts.ReactDOM.unmountComponentAtNode(opts.domElements[props.name]);\n    }\n    delete opts.domElements[props.name];\n    delete opts.renderResults[props.name];\n  });\n}\n\nfunction update(opts, props) {\n  return new Promise((resolve, reject) => {\n    const whenFinished = function () {\n      resolve(this);\n    };\n\n    const elementToRender = getElementToRender(opts, props);\n    const renderedComponent = reactDomRender({\n      elementToRender,\n      domElement: opts.domElements[props.name],\n      whenFinished,\n      opts,\n    });\n  });\n}\n\nfunction getRootDomEl(domElementGetter, props) {\n  const el = domElementGetter(props);\n  if (!el) {\n    throw new Error(\n      `single-spa-react: domElementGetter function for application '${\n        props.appName || props.name\n      }' did not return a valid dom element. Please pass a valid domElement or domElementGetter via opts or props`\n    );\n  }\n\n  return el;\n}\n\nfunction atLeastReact16(React) {\n  if (\n    React &&\n    typeof React.version === \"string\" &&\n    React.version.indexOf(\".\") >= 0\n  ) {\n    const majorVersionString = React.version.slice(\n      0,\n      React.version.indexOf(\".\")\n    );\n    try {\n      return Number(majorVersionString) >= 16;\n    } catch (err) {\n      return false;\n    }\n  } else {\n    return false;\n  }\n}\n\nfunction chooseDomElementGetter(opts, props) {\n  if (props.domElement) {\n    return () => props.domElement;\n  } else if (props.domElementGetter) {\n    return props.domElementGetter;\n  } else if (opts.domElementGetter) {\n    return opts.domElementGetter;\n  } else {\n    return defaultDomElementGetter(props);\n  }\n}\n\nfunction defaultDomElementGetter(props) {\n  const appName = props.appName || props.name;\n  if (!appName) {\n    throw Error(\n      `single-spa-react was not given an application name as a prop, so it can't make a unique dom element container for the react application`\n    );\n  }\n  const htmlId = `single-spa-application:${appName}`;\n\n  return function defaultDomEl() {\n    let domElement = document.getElementById(htmlId);\n    if (!domElement) {\n      domElement = document.createElement(\"div\");\n      domElement.id = htmlId;\n      document.body.appendChild(domElement);\n    }\n\n    return domElement;\n  };\n}\n\nfunction reactDomRender({ opts, elementToRender, domElement }) {\n  if (\n    [\n      \"createRoot\",\n      \"unstable_createRoot\",\n      \"createBlockingRoot\",\n      \"unstable_createBlockingRoot\",\n    ].indexOf(opts.renderType) >= 0\n  ) {\n    const root = opts.ReactDOM[opts.renderType](domElement);\n    root.render(elementToRender);\n    return root;\n  }\n\n  if (opts.renderType === \"hydrate\") {\n    return opts.ReactDOM.hydrate(elementToRender, domElement);\n  }\n\n  // default to this if 'renderType' is null or doesn't match the other options\n  return opts.ReactDOM.render(elementToRender, domElement);\n}\n\nfunction getElementToRender(opts, props, mountFinished) {\n  const rootComponentElement = opts.React.createElement(\n    opts.rootComponent,\n    props\n  );\n\n  let elementToRender = SingleSpaContext\n    ? opts.React.createElement(\n        SingleSpaContext.Provider,\n        { value: props },\n        rootComponentElement\n      )\n    : rootComponentElement;\n\n  if (opts.errorBoundary) {\n    opts.errorBoundaryClass =\n      opts.errorBoundaryClass || createErrorBoundary(opts);\n    elementToRender = opts.React.createElement(\n      opts.errorBoundaryClass,\n      props,\n      elementToRender\n    );\n  }\n\n  // https://github.com/single-spa/single-spa-react/issues/112\n  elementToRender = opts.React.createElement(\n    SingleSpaRoot,\n    {\n      ...props,\n      mountFinished,\n      unmountFinished() {\n        setTimeout(opts.unmountFinished);\n      },\n    },\n    elementToRender\n  );\n\n  // This is a class component, since we need a mount hook and single-spa-react supports React@15 (no useEffect available)\n  function SingleSpaRoot(_props) {\n    SingleSpaRoot.displayName = `SingleSpaRoot(${_props.name})`;\n  }\n\n  SingleSpaRoot.prototype = Object.create(opts.React.Component.prototype);\n  SingleSpaRoot.prototype.componentDidMount = function () {\n    setTimeout(this.props.mountFinished);\n  };\n  SingleSpaRoot.prototype.componentWillUnmount = function () {\n    setTimeout(this.props.unmountFinished);\n  };\n  SingleSpaRoot.prototype.render = function () {\n    return this.props.children;\n  };\n\n  return elementToRender;\n}\n\nfunction createErrorBoundary(opts) {\n  // Avoiding babel output for class syntax and super()\n  // to avoid bloat\n  function SingleSpaReactErrorBoundary(props) {\n    // super\n    opts.React.Component.apply(this, arguments);\n\n    this.state = {\n      caughtError: null,\n      caughtErrorInfo: null,\n    };\n\n    SingleSpaReactErrorBoundary.displayName = `SingleSpaReactErrorBoundary(${props.name})`;\n  }\n\n  SingleSpaReactErrorBoundary.prototype = Object.create(\n    opts.React.Component.prototype\n  );\n\n  SingleSpaReactErrorBoundary.prototype.render = function () {\n    if (this.state.caughtError) {\n      return opts.errorBoundary(\n        this.state.caughtError,\n        this.state.caughtErrorInfo,\n        this.props\n      );\n    } else {\n      return this.props.children;\n    }\n  };\n\n  SingleSpaReactErrorBoundary.prototype.componentDidCatch = function (\n    err,\n    info\n  ) {\n    this.setState({\n      caughtError: err,\n      caughtErrorInfo: info,\n    });\n  };\n\n  return SingleSpaReactErrorBoundary;\n}\n"],"names":["SingleSpaContext","require","createContext","defaultOpts","React","ReactDOM","rootComponent","loadRootComponent","renderType","errorBoundary","errorBoundaryClass","domElementGetter","parcelCanUpdate","suppressComponentDidCatchWarning","domElements","renderResults","bootstrap","opts","props","Promise","resolve","then","resolvedComponent","mount","reject","version","indexOf","majorVersionString","slice","Number","err","atLeastReact16","prototype","componentDidCatch","console","warn","name","appName","childAppName","domElement","Error","htmlId","document","getElementById","createElement","id","body","appendChild","defaultDomElementGetter","chooseDomElementGetter","elementToRender","getElementToRender","this","el","getRootDomEl","renderResult","reactDomRender","unmount","unmountFinished","root","unmountComponentAtNode","update","whenFinished","render","hydrate","mountFinished","rootComponentElement","Provider","value","SingleSpaRoot","_props","displayName","SingleSpaReactErrorBoundary","Component","apply","arguments","state","caughtError","caughtErrorInfo","Object","create","children","info","setState","createErrorBoundary","setTimeout","componentDidMount","componentWillUnmount","userOpts","_typeof","lifecycles","bind"],"mappings":"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"}